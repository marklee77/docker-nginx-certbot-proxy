#!/bin/sh

: ${nginx_certbot_proxy_resolvers:="$(awk '$1 == "nameserver" { print $2 }' ORS=' ' /etc/resolv.conf)"}

for config_dir in /etc/letsencrypt /etc/nginx/http-configs /etc/nginx/https-configs \
                  /etc/nginx/snippets /etc/ssl/nginx /var/lib/certbot-webroot \
                  /var/log/letsencrypt /var/log/nginx /var/www; do
    [ -L "$config_dir" ] && config_dir="$(readlink "$config_dir")"
    [ -d "$config_dir" ] || mkdir -m 0755 -p "$config_dir"
done

# set secure umask
umask 0277

config_file=/etc/ssl/nginx/dh4096.pem
[ -L "$config_file" ] && config_file="$(readlink "$config_file")"
config_dir="$(dirname "$config_file")"
[ -d "$config_dir" ] || mkdir -m 0755 -p "$config_dir"
[ -f "$config_file" ] || openssl dhparam -out "$config_file" 4096

# set normal umask
umask 0022

config_file=/etc/nginx/snippets/resolvers
[ -L "$config_file" ] && config_file="$(readlink "$config_file")"
config_dir="$(dirname "$config_file")"
[ -d "$config_dir" ] || mkdir -m 0755 -p "$config_dir"
[ -f "$config_file" ] || cat > "$config_file" <<EOF
resolver $nginx_certbot_proxy_resolvers;
EOF
